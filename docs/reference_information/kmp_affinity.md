# KMP_AFFINITY

Исходная документация расположена [здесь][intel-kmp-affinity].

## Синтаксис:
```
KMP_AFFINITY=[<modifier>,...]<type>[,<permute>][,<offset>]
```


## Поддерживаемые атрибуты
| **Атрибут** | **По умолчанию** | **Описание** |
|-------------|------------------|--------------|
| *modifier* | *noverbose<br>respect<br>granularity=core*| Необязательный. Строка, состоящая из ключевого слова и спецификатора.<ul><li>*granularity=<*specifier*>*<br>В качестве *specifier* могут быть указаны *fine*, *thread*, *core* или *tile*</li><li>*norespect*</li><li>*noverbose*</li><li>*nowarnings*</li><li>*proclist={<*proc-list*>}*</li><li>*respect*</li><li>*verbose*</li><li>*warnings*</li></ul>|
| *type* | *none*  | Обязательная строка. Указывает используемую привязку потока.<ul><li>*balanced*</li><li>*compact*</li><li>*disabled*</li><li>*explicit*</li><li>*none*</li><li>*scatter*</li><li>*logical* (устарело; используйте *compact*, опустив значение *permute*)</li><li>*physical* (устарело; используйте *scatter*, возможно, указав значение *offset*)</li></ul>|
| *permute* | *0* | Опциональный. Положительное целое число. Недопустимо со значениями типов *explicit*, *none* или *disabled*. |
| *offset* | *0* | Опциональный.  Положительное целое число. Недопустимо со значениями типов *explicit*, *none* или *disabled*. |


## Affinity Types

*Type* - единственный обязательный атрибут.

**type = none (по умолчанию)**  
Не привязывает потоки OpenMP* к конкретным контекстам потока; однако, если операционная система поддерживает привязку, компилятор по-прежнему использует интерфейс привязки потоков OpenMP* для определения топологии машины.

**type = balanced**  
Размещает потоки на отдельных ядрах до тех пор, пока все ядра не будут иметь хотя бы один поток, аналогично типу *scatter*. Однако, когда среда выполнения должна использовать несколько контекстов аппаратных потоков на одном ядре, *balanced* гарантирует, что номера потоков OpenMP* близки друг к другу, чего не происходит в случае *scatter*. Этот тип соответствия поддерживается ЦП только для систем с одним сокетом.

**type = compact**  
Указание *compact* назначает поток OpenMP* \<n>+1 свободному контексту потока как можно ближе к контексту потока, в котором был размещен поток \<n> OpenMP*. Например, на карте топологии, чем ближе узел к корню, тем большее значение имеет узел при сортировке потоков.

**type = disabled**
Указание *disabled* полностью отключает интерфейсы сходства потоков. Это заставляет библиотеку времени выполнения OpenMP* вести себя так, как если бы интерфейс сходства не поддерживался операционной системой. Сюда входят низкоуровневые интерфейсы API, такие как *kmp_set_affinity* и *kmp_get_affinity*, которые не действуют и возвращают ненулевой код ошибки.

**type = explicit**  
При *explicit* потоки OpenMP* назначаются списку идентификаторов процессов ОС, которые были явно указаны с помощью модификатора *proclist=*, который требуется для этого типа соответствия.

**type = scatter**  
При указании *scatter* потоки распределяются по всей системе максимально равномерно. Тип *scatter* противоположен *compact*; поэтому листья узла наиболее важны при сортировке карты топологии машины.

**Устаревшие типы: logical и physical**  
Типы *logical* и *phisical* устарели и могут перестать поддерживаться в будущих версиях. Оба поддерживаются для обратной совместимости.  
Для типов *logical* и *phisical* одно конечное целое число интерпретируется как спецификатор *offset*, а не как спецификатор *permute*. В отличие от *compact* *scatter*, для которых одно конечное целое число интерпретируется как спецификатор *permute*.  
* Тип *logical* назначает потоки OpenMP* последовательным логическим процессорам, которые также называются контекстами аппаратных потоков. Тип эквивалентен *compact*, за исключением того, что спецификатор *permute* не допускается. Таким образом, *KMP_AFFINITY=logical,n* эквивалентно *KMP_AFFINITY=compact,0,n* (эта эквивалентность верна независимо от того, присутствует ли модификатор *granularity=fine*).
* Тип *phisical* назначает потоки последовательным физическим процессорам (ядрам). Для систем, где есть только один контекст потока на ядро, тип эквивалентен *logical*. Для систем, в которых на ядро ​​существует несколько контекстов потоков, *phisical* эквивалентен *compact* со спецификатором *permute*, равным 1; то есть *KMP_AFFINITY=physical,n* эквивалентно *KMP_AFFINITY=compact, 1,n* (независимо от того, присутствует ли модификатор *granularity=fine*). Эта эквивалентность означает, что когда компилятор сортирует карту, он должен переставить самый внутренний уровень карты топологии машины на самый внешний, предположительно уровень контекста потока. Этот тип не поддерживает спецификатор *permute*.


## Modifier Values for Affinity Types

Модификаторы - это необязательные аргументы, предшествующие типу. Если вы не укажете модификатор, модификаторы *noverbose*, *respect* и *granularity=core* будут использованы по умолчанию.

Модификаторы интерпретируются слева направо и могут отрицать друг друга. Например, указание *KMP_AFFINITY=verbose,noverbose,scatter* эквивалентно установке *KMP_AFFINITY=noverbose,scatter* или просто *KMP_AFFINITY=scatter*.

**modifier = noverbose (по умолчанию)**  
Не печатает подробные сообщения.

**modifier = verbose**  
Печатает сообщения о поддерживаемой привязке. Сообщения включают информацию о количестве пакетов, количестве ядер в каждом пакете, количестве контекстов потоков для каждого ядра и привязках потоков OpenMP* к физическим контекстам потоков.  
Информация о привязке потоков OpenMP* к контекстам физических потоков косвенно отображается в форме сопоставлений между контекстами аппаратных потоков и идентификаторами процессора (процесса) операционной системы (ОС). Маска соответствия для каждого потока OpenMP* печатается как набор идентификаторов процессоров ОС.

**modifier = granularity**  
Привязка потоков OpenMP* к определенным пакетам и ядрам часто приводит к увеличению производительности в системах с процессорами Intel с включенной технологией Intel® Hyper-Threading; однако обычно нецелесообразно привязывать каждый поток OpenMP* к определенному контексту потока на определенном ядре. Гранулярность описывает самые низкие уровни, на которых потокам OpenMP* разрешено плавать в пределах карты топологии.
| **Specifier** | **Описание** |
|---------------|--------------|
| *core* | По умолчанию. Позволяет всем потокам OpenMP*, привязанным к ядру, перемещаться между различными контекстами потоков. |
| *fine* или *thread* | Самый тонкий уровень детализации. Вызывает привязку каждого потока OpenMP* к одному контексту потока. Эти два спецификатора функционально эквивалентны. |
| *tile* | Позволяет всем потокам OpenMP*, привязанным к *tile*, перемещаться между различными контекстами потоков ядер, из которых состоит *tile*. |

**modifier = respect (по умолчанию)**  
Соблюдает исходную affinity-маску процесса или, точнее, affinity-маску, установленную для потока, который инициализирует библиотеку времени выполнения OpenMP*. Поведение отличается в Linux и Windows:
* В Windows: соблюдает исходную affinity-маску для процесса.
* В Linux: соблюдает affinity-маску для потока, который инициализирует библиотеку времени выполнения OpenMP*.

**modifier = norespect**  
Не соблюдает оригинальную affinity-маску для процесса. Связывает потоки OpenMP* со всеми процессорами операционной системы.

**modifier = nowarnings**  
Не печатать предупреждающие сообщения интерфейса affinity.

**modifier = warnings (по умолчанию)**  
Печать предупреждающих сообщений интерфейса affinity.


<!-- LINKS -->
[intel-kmp-affinity]: https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/optimization-and-programming-guide/openmp-support/openmp-library-support/thread-affinity-interface-linux-and-windows.html